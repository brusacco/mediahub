<% content_for :extra_stylesheets do %>
  <style>
    /* Hide scrollbar for Chrome, Safari and Opera */
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
      scroll-padding-top: 4rem;
    }
    /* Ensure sticky navigation stays above all content */
    #topic-nav {
      position: sticky;
      position: -webkit-sticky;
      top: 0;
      z-index: 9999;
      background: white;
      width: 100%;
    }
  </style>
<% end %>

<!-- Enhanced Header -->
<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="max-w-full mx-auto px-4 py-6 sm:px-6 lg:px-12 xl:px-16">
    <div class="md:flex md:items-center md:justify-between">
      <div class="flex-1 min-w-0">
        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">
          <i class="fas fa-tv text-indigo-500 mr-2" aria-hidden="true"></i><%= @topic.name %>
        </h1>
        <p class="mt-1 text-sm text-gray-600">Análisis completo del tópico - Últimos <%= DAYS_RANGE %> días</p>
      </div>
      <div class="mt-4 flex flex-col sm:flex-row gap-2 md:mt-0 md:ml-4">
        <button onclick="window.print()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
          <i class="fa-solid fa-print mr-2"></i>
          Imprimir PDF
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Breadcrumbs -->
<%= render 'shared/breadcrumbs', items: [
  { label: 'Inicio', path: root_path, icon: 'fa-solid fa-home' },
  { label: 'Tópicos', path: nil },
  { label: @topic.name, path: nil, current: true }
] %>

<!-- Sticky Navigation -->
<%= render 'shared/sticky_nav', nav_items: [
  { href: '#kpis', text: 'Métricas', icon: 'fa-solid fa-gauge-high', label: 'Ir a sección de métricas clave' },
  { href: '#temporal', text: 'Temporal', icon: 'fa-solid fa-clock', label: 'Ir a análisis temporal' },
  { href: '#distribucion', text: 'Distribución', icon: 'fa-solid fa-chart-pie', label: 'Ir a distribución de contenido' },
  { href: '#estaciones', text: 'Estaciones', icon: 'fa-solid fa-building', label: 'Ir a estaciones destacadas' },
  { href: '#bigramas', text: 'Bigramas', icon: 'fa-solid fa-comments', label: 'Ir a análisis de bigramas' },
  { href: '#nube-palabras', text: 'Nube', icon: 'fa-solid fa-cloud', label: 'Ir a nube de palabras' },
  { href: '#etiquetas', text: 'Etiquetas', icon: 'fa-solid fa-tags', label: 'Ir a etiquetas' },
  { href: '#videos-section', text: 'Videos', icon: 'fa-solid fa-video', label: 'Ir a tabla de videos' }
] %>

<main class="bg-gray-50 min-h-screen">
  <div class="max-w-full mx-auto py-8 px-4 sm:px-6 lg:px-12 xl:px-16">

    <!-- KPI Cards -->
    <section class="mb-8" id="kpis">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <%= render 'shared/kpi_card', 
              title: 'Clips',
              icon: 'fa-solid fa-video',
              value: number_with_delimiter(@total_videos, delimiter: "."),
              description: "Clips etiquetados con este tópico en los últimos #{DAYS_RANGE} días." %>
        
        <%= render 'shared/kpi_card',
              title: 'Estaciones',
              icon: 'fa-solid fa-tower-broadcast',
              value: @videos.joins(:station).distinct.count('stations.id'),
              description: "Estaciones diferentes que han mencionado este tópico." %>
        
        <%= render 'shared/kpi_card',
              title: 'Etiquetas',
              icon: 'fa-solid fa-tags',
              value: @tags.size,
              description: "Etiquetas relacionadas encontradas en los clips." %>
        
        <%= render 'shared/kpi_card',
              title: 'Palabras Únicas',
              icon: 'fa-solid fa-font',
              value: @word_occurrences.size,
              description: "Palabras diferentes analizadas en las transcripciones." %>
      </div>
    </section>

    <!-- Tags Section -->
    <% if @topic.tags.any? %>
      <section class="mb-8" id="etiquetas">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Etiquetas del Tópico</h2>
          <div class="flex flex-wrap gap-2">
            <%= render partial: "tags/tag_entry", collection: @topic.tags %>
          </div>
        </div>
      </section>
    <% end %>

    <!-- Section: Time Series Analysis -->
    <section class="mb-8" id="temporal">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">
          <i class="fa-solid fa-chart-line text-indigo-600 mr-2"></i>
          Análisis Temporal
        </h2>
        <p class="mt-2 text-base text-gray-600">
          Evolución de clips en los últimos <%= DAYS_RANGE %> días
        </p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8">
        <%= column_chart @videos.group_by_day(:posted_at).count('*'), xtitle: "Fecha", ytitle: "Cant. Clips", label: "Clips", colors: ['indigo'] %>
      </div>
    </section>

    <!-- Section: Distribution Charts -->
    <section class="mb-8" id="distribucion">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">
          <i class="fa-solid fa-chart-pie text-indigo-600 mr-2"></i>
          Distribución de Contenido
        </h2>
        <p class="mt-2 text-base text-gray-600">
          Análisis de clips por estación y etiquetas relacionadas
        </p>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
        <!-- Chart: Clips por Estación -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">
            Clips por Estación
          </h3>
          <%= pie_chart @videos.group("stations.name").count('*'), donut: true %>
        </div>
        <!-- Chart: Clips por Tag -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">
            Clips por Etiqueta Relacionada
          </h3>
          <%= pie_chart @tags_count, donut: true %>
        </div>
      </div>
    </section>

    <!-- Section: Top Stations -->
    <section class="mb-8" id="estaciones">
      <%= render partial: 'stations/station', 
                locals: { 
                  stations: @videos.group("stations.id, stations.name")
                                    .count('*')
                                    .sort_by { |_, count| -count }
                                    .take(10)
                                    .map { |station, count| { station: Station.find_by(name: station), count: count } },
                  title: 'Las estaciones que más han mencionado este Tópico fueron:' } %>
    </section>

    <!-- Section: Bigrams Analysis -->
    <section class="mb-8" id="bigramas">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">
          <i class="fa-solid fa-comments text-indigo-600 mr-2"></i>
          Análisis de Bigramas
        </h2>
        <p class="mt-2 text-base text-gray-600">
          Pares de palabras más frecuentes en los clips
        </p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8">
        <div class="flex flex-wrap gap-2">
          <%= render partial: "tags/tag_pill_array", collection: @bigram_occurrences, cached: true %>
        </div>
        <p class="mt-4 text-sm text-gray-500">
          *Cantidad de veces que aparecen bigramas en los clips
        </p>
      </div>
    </section>

    <!-- Section: Word Cloud -->
    <section class="mb-8" id="nube-palabras">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">
          <i class="fa-solid fa-cloud text-indigo-600 mr-2"></i>
          Nube de Palabras
        </h2>
        <p class="mt-2 text-base text-gray-600">
          Visualización de las palabras más frecuentes en los clips de este tópico
        </p>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 lg:p-12">
        <div class="min-h-[400px] flex items-center justify-center">
          <% min_max = find_max_and_min_occurrences(@word_occurrences) %>
          <ul class="cloud">
            <% @word_occurrences.shuffle { |a, b| a[1] <=> b[1] }.each do |word, value| %>
              <li data-weight="<%= normalize_to_scale(value, min_max[:max], min_max[:min]) %>"><%= word %></li>
            <%end%>
          </ul>
        </div>
      </div>
    </section>

    <!-- Section: Tags Appearance -->
    <% if @tags.any? %>
      <section class="mb-8 no-print" id="etiquetas-relacionadas">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-900">
            <i class="fa-solid fa-tags text-indigo-600 mr-2"></i>
            Aparición de Etiquetas
          </h2>
          <p class="mt-2 text-base text-gray-600">
            Frecuencia de etiquetas relacionadas en los clips
          </p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8">
          <div class="flex flex-wrap gap-2">
            <%= render partial: "tags/tag_pill", collection: @tags, cached: true %>
          </div>
          <p class="mt-4 text-sm text-gray-500">
            *Cantidad de veces que aparecen las etiquetas en los clips
          </p>
        </div>
      </section>
    <% end %>

    <!-- Section: Recent Videos Table -->
    <section class="mb-8" id="videos-section">
      <%= render partial: 'videos/table', locals: { videos: @videos, title: "Últimos Clips sobre #{@topic.name}" } %>
    </section>

  </div>
</main>

<style>
  @media print {
    .no-print {
      display: none;
    }
    #topic-nav {
      display: none;
    }
  }
</style>
