<% content_for :extra_stylesheets do %>
  <style>
    /* Highcharts background fix - white background */
    .highcharts-container {
      background-color: white !important;
    }
    .highcharts-background {
      fill: white !important;
    }
    .highcharts-plot-background {
      fill: white !important;
    }
    .highcharts-plot-border {
      fill: white !important;
    }
    /* Ensure grid lines are visible */
    .highcharts-grid-line {
      stroke: #E5E7EB !important;
      stroke-width: 1px !important;
      opacity: 1 !important;
    }
    .highcharts-yaxis-grid .highcharts-grid-line {
      stroke: #E5E7EB !important;
      stroke-width: 1px !important;
      opacity: 1 !important;
    }
    /* Remove pie chart borders */
    .highcharts-series path {
      stroke: transparent !important;
      stroke-width: 0 !important;
    }
    .highcharts-pie-series .highcharts-point {
      stroke: transparent !important;
      stroke-width: 0 !important;
    }
  </style>
<% end %>

<!-- Enhanced Header -->
<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="max-w-full mx-auto px-4 py-6 sm:px-6 lg:px-12 xl:px-16">
    <div class="md:flex md:items-center md:justify-between">
      <div class="flex-1 min-w-0">
        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">
          <i class="fas fa-tag text-indigo-500 mr-2" aria-hidden="true"></i><%= @tag.name %>
        </h1>
        <p class="mt-1 text-sm text-gray-600">
          La etiqueta en los últimos <%= DAYS_RANGE %> días cuenta con un total de 
          <span class="font-semibold text-indigo-600"><%= number_with_delimiter(@total_videos, delimiter: ".") %></span> clips.
        </p>
      </div>
      <div class="mt-4 flex flex-col sm:flex-row gap-2 md:mt-0 md:ml-4">
        <button onclick="window.print()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
          <i class="fa-solid fa-print mr-2"></i>
          Imprimir PDF
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Breadcrumbs -->
<%= render 'shared/breadcrumbs', items: [
  { label: 'Inicio', path: root_path, icon: 'fa-solid fa-home' },
  { label: 'Etiquetas', path: nil },
  { label: @tag.name, path: nil, current: true }
] %>

<!-- Sticky Navigation -->
<%= render 'shared/sticky_nav', nav_items: [
  { href: '#kpis', text: 'Métricas', icon: 'fa-solid fa-gauge-high', label: 'Ir a sección de métricas clave' },
  { href: '#temporal', text: 'Temporal', icon: 'fa-solid fa-clock', label: 'Ir a análisis temporal' },
  { href: '#distribucion', text: 'Distribución', icon: 'fa-solid fa-chart-pie', label: 'Ir a distribución de contenido' },
  { href: '#estaciones', text: 'Estaciones', icon: 'fa-solid fa-building', label: 'Ir a estaciones destacadas' },
  { href: '#videos-section', text: 'Videos', icon: 'fa-solid fa-video', label: 'Ir a tabla de videos' },
  { href: '#bigramas', text: 'Bigramas', icon: 'fa-solid fa-comments', label: 'Ir a análisis de bigramas' },
  { href: '#nube-palabras', text: 'Nube', icon: 'fa-solid fa-cloud', label: 'Ir a nube de palabras' },
  { href: '#etiquetas', text: 'Etiquetas', icon: 'fa-solid fa-tags', label: 'Ir a etiquetas relacionadas' }
] %>

<!-- Main Content -->
<main class="bg-gray-50 min-h-screen">
  <div class="max-w-full mx-auto py-8 px-4 sm:px-6 lg:px-12 xl:px-16">

    <!-- KPI Cards -->
    <section class="mb-8" id="kpis">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <%= render 'shared/kpi_card', 
              title: 'Clips',
              icon: 'fa-solid fa-video',
              value: number_with_delimiter(@total_videos, delimiter: "."),
              description: "Clips etiquetados con esta etiqueta en los últimos #{DAYS_RANGE} días." %>
        
        <%= render 'shared/kpi_card',
              title: 'Estaciones',
              icon: 'fa-solid fa-tower-broadcast',
              value: @videos.joins(:station).distinct.count('stations.id'),
              description: "Estaciones diferentes que han mencionado esta etiqueta." %>
        
        <%= render 'shared/kpi_card',
              title: 'Etiquetas Relacionadas',
              icon: 'fa-solid fa-tags',
              value: @tags.size,
              description: "Etiquetas relacionadas encontradas en los clips." %>
        
        <%= render 'shared/kpi_card',
              title: 'Palabras Únicas',
              icon: 'fa-solid fa-font',
              value: @word_occurrences.size,
              description: "Palabras diferentes analizadas en las transcripciones." %>
      </div>
    </section>

<!-- Section: Time Series Analysis -->
<section class="mb-8" id="temporal">
  <h2 class="text-2xl font-bold text-gray-900 mb-6">
    <i class="fa-solid fa-chart-line text-indigo-600 mr-2"></i>
    Análisis Temporal
  </h2>
  
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-medium text-gray-900">Clips por Día</h3>
      <span class="text-sm text-gray-500">
        Últimos <%= DAYS_RANGE %> días
      </span>
    </div>
    
    <!-- Chart -->
    <div data-controller="chart-modal" 
         data-chart-modal-id-value="temporalChart"
         data-chart-modal-url-value="<%= videos_by_date_tags_path %>"
         data-chart-modal-tag-id-value="<%= @tag.id %>"
         class="w-full overflow-hidden">
      <%= column_chart @videos.group_by_day(:posted_at).count, 
            id: "temporalChart",
            xtitle: "Fecha", 
            ytitle: "Cant. Clips", 
            label: "Clips", 
            colors: ['#6366F1'],
            adapter: 'highcharts',
            thousands: '.' %>
      <%= render 'shared/chart_modal', graph_id: 'temporalChart' %>
    </div>
  </div>
</section>

<!-- Section: Distribution Charts -->
<section class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8" id="distribucion">
    <div class="mb-6">
      <h2 class="text-2xl font-bold tracking-tight text-gray-900 sm:text-3xl">
        Distribución de Contenido
      </h2>
      <p class="mt-2 text-base text-gray-600">
        Análisis de clips por estación y etiquetas relacionadas
      </p>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
      <!-- Chart: Clips por Estación -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          Clips por Estación
        </h3>
        <%= pie_chart @videos.group("stations.name").count('*'), 
              donut: true,
              adapter: 'highcharts',
              thousands: '.',
              library: {
                plotOptions: {
                  pie: {
                    borderWidth: 0,
                    borderColor: 'transparent'
                  }
                }
              } %>
      </div>
      <!-- Chart: Clips por Tag -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          Clips por Etiqueta Relacionada
        </h3>
        <%= pie_chart @tags_count, 
              donut: true,
              adapter: 'highcharts',
              thousands: '.',
              library: {
                plotOptions: {
                  pie: {
                    borderWidth: 0,
                    borderColor: 'transparent'
                  }
                }
              } %>
      </div>
    </div>
</section>

<!-- Section: Top Stations -->
<section class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8" id="estaciones">
    <%= render partial: 'stations/station', 
              locals: { 
                stations: @videos.group("stations.id, stations.name")
                                  .count('*')
                                  .sort_by { |_, count| -count }
                                  .take(10)
                                  .map { |station, count| { station: Station.find_by(name: station), count: count } },
                title: 'Las estaciones que más han mencionado esta Etiqueta fueron:' } %>
</section>

<!-- Section: Recent Videos Table -->
<section class="mb-8" id="videos-section">
    <%= render partial: 'videos/table', locals: { videos: @videos, title: "Últimos Clips sobre #{@tag.name}" } %>
</section>

<!-- Section: Bigrams Analysis -->
<section class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8" id="bigramas">
    <div class="mb-6">
      <h2 class="text-2xl font-bold tracking-tight text-gray-900 sm:text-3xl">
        Análisis de Bigramas
      </h2>
      <p class="mt-2 text-base text-gray-600">
        Pares de palabras más frecuentes en los clips
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <%= render partial: "tags/tag_pill_array", collection: @bigram_occurrences, cached: true %>
    </div>
    <p class="mt-4 text-sm text-gray-500">
      *Cantidad de veces que aparecen bigramas en los clips
    </p>
</section>

<!-- Section: Word Cloud -->
<section class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8" id="nube-palabras">
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold tracking-tight text-gray-900 sm:text-3xl">
        Nube de Palabras
      </h2>
      <p class="mt-2 text-base text-gray-600 max-w-2xl mx-auto">
        Visualización de las palabras más frecuentes en los clips de esta etiqueta
      </p>
    </div>
    <div class="min-h-[400px] flex items-center justify-center">
      <% min_max = find_max_and_min_occurrences(@word_occurrences) %>
      <ul class="cloud">
        <% @word_occurrences.shuffle { |a, b| a[1] <=> b[1] }.each do |word, value| %>
          <li data-weight="<%= normalize_to_scale(value, min_max[:max], min_max[:min]) %>"><%= word %></li>
        <%end%>
      </ul>
    </div>
</section>

<!-- Section: Tags Appearance -->
<% if @tags.any? %>
  <section class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6 lg:p-8 no-print" id="etiquetas">
      <div class="mb-6">
        <h2 class="text-2xl font-bold tracking-tight text-gray-900 sm:text-3xl">
          Aparición de Etiquetas
        </h2>
        <p class="mt-2 text-base text-gray-600">
          Frecuencia de etiquetas relacionadas en los clips
        </p>
      </div>
      <div class="flex flex-wrap gap-2">
        <%= render partial: "tags/tag_pill", collection: @tags, cached: true %>
      </div>
      <p class="mt-4 text-sm text-gray-500">
        *Cantidad de veces que aparecen las etiquetas en los clips
      </p>
  </section>
<% end %>

  </div>
</main>
